{"componentChunkName":"component---src-templates-post-template-js","path":"/posts/deploy-docker-using-github-actions-to-google-cloud-run","result":{"data":{"markdownRemark":{"id":"5ff6da81-484a-53a9-9247-3482f76eaa59","html":"<p><img src=\"/media/cloud_run/cloud_run/deploy-docker-using-github-actions-to-google-cloud-run.png\" alt=\"Deploy Docker using Github Actions to Google cloud RUn\"></p>\n<p>You can use google free tier to deploy any docker containers  into cloud run (\nFully managed compute platform for deploying and scaling containerized applications quickly and securely). </p>\n<p>Steps:</p>\n<ol>\n<li>\n<p>Make Dockerfile for you project and run your project on port 8080 (your programe should run on 8080. Google only map 8080 to 80 to deploy the app).</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\"># build environment\nFROM node:alpine as builder</code></pre></div>\n</li>\n</ol>\n<p>RUN apk update &#x26;&#x26; apk add —no-cache make git python autoconf g++ libc6-compat libjpeg-turbo-dev libpng-dev nasm</p>\n<p>WORKDIR /usr/src/app\nCOPY . .</p>\n<p>RUN yarn install\nRUN yarn build</p>\n<h1 id=\"server-environment\" style=\"position:relative;\"><a href=\"#server-environment\" aria-label=\"server environment permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>server environment</h1>\n<p>FROM nginx:alpine\nRUN rm -rf /usr/share/nginx/html/*\nCOPY nginx.conf /etc/nginx/conf.d/configfile.template\nENV PORT 8080\nENV HOST 0.0.0.0\nRUN sh -c “envsubst ’$PORT’  &#x3C; /etc/nginx/conf.d/configfile.template > /etc/nginx/conf.d/default.conf”\nCOPY —from=builder /usr/src/app/public /usr/share/nginx/html\nEXPOSE 8080\nCMD [“nginx”, “-g”, “daemon off;”]</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">2. Make project into google cloud and get gcloud service key with the following permissions:\n- Service Account User\n- Cloud Run Admin\n- Storage Admin\n3. Convert your google service key to base64 encoding and add to github secrets in setting as ``GCP_CLOUD_RUN_SERVICE_KEY``. Also add project id as ``GCP_PROJECT_ID`` to secrets.\n4. Add github actions.</code></pre></div>\n<p>name: Docker</p>\n<p>on:\npush:\n# Publish <code class=\"language-text\">master</code> as Docker <code class=\"language-text\">latest</code> image.\nbranches:\n- master</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\"># Publish `v1.2.3` tags as releases.\ntags:\n  - v*</code></pre></div>\n<h1 id=\"run-tests-for-any-prs\" style=\"position:relative;\"><a href=\"#run-tests-for-any-prs\" aria-label=\"run tests for any prs permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Run tests for any PRs.</h1>\n<p>  pull_request:</p>\n<p>env:</p>\n<h1 id=\"todo-change-variable-to-your-images-name\" style=\"position:relative;\"><a href=\"#todo-change-variable-to-your-images-name\" aria-label=\"todo change variable to your images name permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>TODO: Change variable to your image’s name.</h1>\n<p>  IMAGE_NAME: bkrm-blog</p>\n<p>jobs:</p>\n<h1 id=\"push-image-to-github-packages\" style=\"position:relative;\"><a href=\"#push-image-to-github-packages\" aria-label=\"push image to github packages permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Push image to GitHub Packages.</h1>\n<h1 id=\"see-also-httpsdocsdockercomdocker-hubbuilds\" style=\"position:relative;\"><a href=\"#see-also-httpsdocsdockercomdocker-hubbuilds\" aria-label=\"see also httpsdocsdockercomdocker hubbuilds permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>See also <a href=\"https://docs.docker.com/docker-hub/builds/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://docs.docker.com/docker-hub/builds/</a></h1>\n<p>  push:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">runs-on: ubuntu-latest\nif: github.event_name == &#39;push&#39;\n\nsteps:\n  - uses: actions/checkout@v2\n\n  - name: Build image\n    run: docker build . --file Dockerfile --tag $IMAGE_NAME\n\n  - name: Log into registry\n    run: echo &quot;${{ secrets.GITHUB_TOKEN }}&quot; | docker login docker.pkg.github.com -u ${{ github.actor }} --password-stdin\n\n  - name: Push image\n    run: |\n      IMAGE_ID=docker.pkg.github.com/${{ github.repository }}/$IMAGE_NAME\n\n      # Change all uppercase to lowercase\n      IMAGE_ID=$(echo $IMAGE_ID | tr &#39;[A-Z]&#39; &#39;[a-z]&#39;)\n\n      # Strip git ref prefix from version\n      VERSION=$(echo &quot;${{ github.ref }}&quot; | sed -e &#39;s,.*/\\(.*\\),\\1,&#39;)\n\n      # Strip &quot;v&quot; prefix from tag name\n      [[ &quot;${{ github.ref }}&quot; == &quot;refs/tags/&quot;* ]] &amp;&amp; VERSION=$(echo $VERSION | sed -e &#39;s/^v//&#39;)\n\n      # Use Docker `latest` tag convention\n      [ &quot;$VERSION&quot; == &quot;master&quot; ] &amp;&amp; VERSION=latest\n\n      echo IMAGE_ID=$IMAGE_ID\n      echo VERSION=$VERSION\n\n      docker tag $IMAGE_NAME $IMAGE_ID:$VERSION\n      docker push $IMAGE_ID:$VERSION\n      \n      # tag image for gcp\n      IMAGE_ID_GCP=asia.gcr.io/${{ secrets.GCP_PROJECT_ID }}/bkrmblog:$VERSION\n      echo $IMAGE_ID_GCP\n      docker tag $IMAGE_ID:$VERSION $IMAGE_ID_GCP\n      \n  - name: Deploy service to Cloud Run\n    uses: BkrmDahal/action-cloud-run@v1.1.2\n    with:\n      image: asia.gcr.io/${{ secrets.GCP_PROJECT_ID }}/bkrmblog:$VERSION\n      service: bkrm-blog\n      version: $VERSION\n      project: ${{ secrets.GCP_PROJECT_ID }}\n      region: asia-southeast1\n      service key: ${{ secrets.GCP_CLOUD_RUN_SERVICE_KEY }}</code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">5. After each commit your code will be deployed to cloud run. You can get url for service from cloud run dashboard. You can also use map this url to subdomain using map feature \n  \nQuote from book I am reading:  \n\n&gt; _“It&#39;s easy to say yes. Yes to another feature, yes to an overly optimistic deadline, yes to a mediocre design. Soon, the stack of things you&#39;ve said yes to grows so tall you cant even see the things you should really be doing”_ \n&gt; \n&gt; __― Rework__</code></pre></div>","fields":{"slug":"/posts/deploy-docker-using-github-actions-to-google-cloud-run","tagSlugs":["/tag/docker/","/tag/gcp/","/tag/github-actions/","/tag/cloud-run/"]},"frontmatter":{"date":"2020-09-19T22:12:03.284Z","description":"Deploy docker automatically from github to cloud run using github actions.","tags":["docker","gcp","github-actions","cloud-run"],"title":"Deploy Docker using Github Actions to Google cloud Run","socialImage":"/media/cloud_run/cloud_run/deploy-docker-using-github-actions-to-google-cloud-run.png"}}},"pageContext":{"slug":"/posts/deploy-docker-using-github-actions-to-google-cloud-run"}}}